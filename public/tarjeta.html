<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR Compras GAME </title>

  <!-- Librer√≠as principales -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

  <style>
  /* (todo tu CSS sigue igual, sin tocar nada) */
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

  body { 
    margin: 0; 
    overflow: hidden; 
    font-family: 'Orbitron', sans-serif; 
    background: radial-gradient(circle at center, #081229 0%, #050b18 100%);
    color: #fff;
  }

  #brandInfo {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 255, 255, 0.1);
    color: #00fff7;
    padding: 12px 24px;
    border: 1px solid #00fff7;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
    text-shadow: 0 0 12px #00fff7;
    display: none;
    z-index: 15;
  }

  #overlay {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(8, 18, 41, 0.9);
    padding: 20px 24px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
    z-index: 15;
    width: 90%;
    max-width: 400px;
    border: 2px solid #00fff7;
    display: none;
    animation: fadeIn 0.6s ease-out;
  }

  #question {
    font-size: 1.1rem;
    color: #00fff7;
    margin-bottom: 12px;
    text-shadow: 0 0 10px #00fff7;
  }

  #overlay button {
    margin: 8px 10px;
    padding: 10px 16px;
    border: 2px solid transparent;
    border-radius: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.3s ease;
    font-family: 'Orbitron', sans-serif;
  }

  #btnYes {
    background: transparent;
    color: #00fff7;
    border-color: #00fff7;
    box-shadow: 0 0 10px #00fff7;
  }

  #btnYes:hover {
    background: #00fff7;
    color: #081229;
    box-shadow: 0 0 20px #00fff7;
  }

  #btnNo {
    background: transparent;
    color: #ff3c3c;
    border-color: #ff3c3c;
    box-shadow: 0 0 10px #ff3c3c;
  }

  #btnNo:hover {
    background: #ff3c3c;
    color: #fff;
    box-shadow: 0 0 20px #ff3c3c;
  }

  #result {
    margin-top: 12px;
    font-weight: bold;
    color: #fff;
    text-shadow: 0 0 8px #00fff7;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, 20px); }
    to { opacity: 1; transform: translate(-50%, 0); }
  }
</style>

</head>

<body>

  <!-- üéµ BOT√ìN INVISIBLE PARA ACTIVAR M√öSICA (requerido por navegador) -->
  <button id="playAudioBtn" style="display:none;">Play</button>

  <div id="brandInfo">Apunta la c√°mara a un marcador</div>

  <div id="overlay">
    <div id="question">¬øQuieres comprar este producto?</div>
    <div>
      <button id="btnYes">S√≠, comprar</button>
      <button id="btnNo">No, gracias</button>
    </div>
    <div id="result" style="margin-top:10px; font-weight:bold;"></div>
  </div>

  <a-scene embedded vr-mode-ui="enabled: false"
           renderer="antialias: true; colorManagement: true"
           arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
      <a-asset-item id="meta" src="../animaciones/meta-gafas.glb"></a-asset-item>
      <a-asset-item id="alphabet" src="../models/COFRE_NEW_BLENDER.glb"></a-asset-item>
      <a-asset-item id="netflix" src="../models/anetflix.glb"></a-asset-item>
      <a-asset-item id="nike" src="../animaciones/nike.glb"></a-asset-item>
      <a-asset-item id="mcdonalds" src="../animaciones/ANIMATION_COMIDA3.glb"></a-asset-item>
      <a-asset-item id="apple" src="../models/cofremacrotado.glb"></a-asset-item>
    </a-assets>

    <a-entity camera></a-entity>

    <!-- MARCADORES (todo igual) -->
    <a-marker type="pattern" id="marker-meta" url="https://sebastianlarrottadev.github.io/brainbroker/targets-3/metas.patt" emitevents="true">
      <a-entity id="model-meta" gltf-model="#meta" scale="0.5 0.5 0.5" visible="true" animation-mixer></a-entity>
    </a-marker>

    <a-marker type="pattern" id="marker-alphabet" url="targets-3/alphabet.patt" emitevents="true">
      <a-entity id="model-alphabet" gltf-model="#alphabet" scale="0.5 0.5 0.5" visible="true" animation-mixer></a-entity>
    </a-marker>

    <a-marker type="pattern" id="marker-netflix" url="targets-3/netflix.patt" emitevents="true">
      <a-entity id="model-netflix" gltf-model="#netflix" scale="0.5 0.5 0.5" visible="true" animation-mixer></a-entity>
    </a-marker>

    <a-marker type="pattern" id="marker-nike" url="targets-3/nike.patt" emitevents="true">
      <a-entity id="model-nike" gltf-model="#nike" scale="0.5 0.5 0.5" visible="true" animation-mixer></a-entity>
    </a-marker>

    <a-marker type="pattern" id="marker-mcdonalds" url="targets-3/mcdonals.patt" emitevents="true">
      <a-entity id="model-mcdonalds" gltf-model="#mcdonalds" scale="0.5 0.5 0.5" visible="true" animation-mixer></a-entity>
    </a-marker>

    <a-marker type="pattern" id="marker-apple" url="targets-3/apple.patt" emitevents="true">
      <a-entity id="model-apple" gltf-model="#apple" scale="0.5 0.5 0.5"
                visible="true" animation-mixer="loop: once; clampWhenFinished: true"></a-entity>
    </a-marker>

    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>
  </a-scene>

  <script>
    /* (TODO TU SCRIPT COMPLETO SIN CAMBIAR NADA) */

    const overlay = document.getElementById("overlay");
    const question = document.getElementById("question");
    const result = document.getElementById("result");
    const btnYes = document.getElementById("btnYes");
    const btnNo = document.getElementById("btnNo");
    const brandInfo = document.getElementById("brandInfo");

    let priceBox = document.createElement("div");
    priceBox.id = "priceBox";
    priceBox.style.marginTop = "10px";
    priceBox.style.fontSize = "1rem";
    priceBox.style.color = "#00fff7";
    priceBox.style.textShadow = "0 0 10px #00fff7";
    overlay.appendChild(priceBox);

    const brandPrices = {
      "Meta": { compra: 170, renta: 30 },
      "Alphabet": { compra: 200, renta: 36 },
      "Netflix": { compra: 180, renta: 32 },
      "Nike": { compra: 140, renta: 25 },
      "McDonald‚Äôs": { compra: 160, renta: 28 },
      "Apple": { compra: 220, renta: 40 },
    };

    const markers = [
      { id: "marker-meta", name: "Meta" },
      { id: "marker-alphabet", name: "Alphabet" },
      { id: "marker-netflix", name: "Netflix" },
      { id: "marker-nike", name: "Nike" },
      { id: "marker-mcdonalds", name: "McDonald‚Äôs" },
      { id: "marker-apple", name: "Apple" }
    ];

    let currentBrand = null;
    let currentModel = null;
    let currentMixer = null;
    let currentAction = null;
    let clock = new THREE.Clock();
    let halfway = 0;
    let animationPaused = false;
    let lostTimeout = null;
    let smoothTarget = null;

    markers.forEach(({ id, name }) => {
      const marker = document.getElementById(id);
      const model = document.getElementById("model-" + id.split("marker-")[1]);

      marker.addEventListener("markerFound", () => {
        currentBrand = name;

        brandInfo.textContent = `üîç Empresa detectada: ${name}`;
        brandInfo.style.display = "block";

        overlay.style.display = "block";
        result.textContent = "";

        const precios = brandPrices[name];
        priceBox.innerHTML = `
          <strong>${name}</strong><br>
          üí≤ Compra: $${precios.compra}<br>
          üí≥ Renta: $${precios.renta}
        `;

        question.textContent = `¬øQuieres comprar ${name}?`;
      });

      marker.addEventListener("markerLost", () => {
        brandInfo.style.display = "none";
        overlay.style.display = "none";
        priceBox.innerHTML = "";
      });
    });

    AFRAME.registerComponent("control-anim", {
      tick: function () {
        if (currentMixer && !animationPaused) {
          currentMixer.update(clock.getDelta());
        }
        if (currentModel && smoothTarget) {
          const currentPos = currentModel.object3D.position;
          currentPos.lerp(smoothTarget, 0.05);
        }
      }
    });

    document.querySelector("a-scene").setAttribute("control-anim", "");

    markers.forEach(({ id, name }) => {
      const marker = document.getElementById(id);
      const model = document.getElementById("model-" + id.split("marker-")[1]);

      marker.addEventListener("markerFound", () => {
        clearTimeout(lostTimeout);
        smoothTarget = null;
        model.setAttribute("visible", true);
        currentBrand = name;
        currentModel = model;
        brandInfo.textContent = `üîç Empresa detectada: ${name}`;
        brandInfo.style.display = "block";
        question.textContent = `¬øQuieres comprar ${name}?`;
        result.textContent = "";
        overlay.style.display = "block";

        const threeObj = model.object3D;
        if (threeObj && threeObj.children.length > 0) {
          const gltfScene = threeObj.children[0];
          if (gltfScene.animations && gltfScene.animations.length > 0) {
            const mixer = new THREE.AnimationMixer(gltfScene);
            const action = mixer.clipAction(gltfScene.animations[0]);
            action.reset();
            action.setLoop(THREE.LoopOnce);
            action.clampWhenFinished = true;
            action.play();
            currentMixer = mixer;
            currentAction = action;
            clock.start();
            animationPaused = false;
            halfway = action.getClip().duration / 2;

            const checkHalf = setInterval(() => {
              if (currentMixer && currentAction && currentAction.time >= halfway) {
                animationPaused = true;
                clock.stop();
                clearInterval(checkHalf);
              }
            }, 100);
          }
        }
      });

      marker.addEventListener("markerLost", () => {
        model.setAttribute("visible", true);
        if (currentModel === model) {
          animationPaused = true;
          clock.stop();

          const currentPos = currentModel.object3D.position.clone();
          const targetPos = currentPos.clone();
          targetPos.y -= 0.1;
          smoothTarget = targetPos;

          lostTimeout = setTimeout(() => {
            if (currentModel === model) {
              currentMixer = null;
              currentAction = null;
              clock.stop();
              animationPaused = false;
              brandInfo.style.display = "none";
              overlay.style.display = "none";
            }
          }, 4000);
        }
      });
    });

    btnYes.addEventListener("click", () => {
        if (currentMixer && currentAction) {
            console.log("‚ñ∂ Continuando animaci√≥n hasta el final...");
            animationPaused = false;
            clock.start();

            result.textContent = "üí∏ Has hecho una compra impulsiva (-10 salud mental)";
            result.style.color = "#ff3c3c";
            result.style.textShadow = "0 0 10px #ff3c3c";
            result.style.display = "block";

            const checkEnd = setInterval(() => {
            if (currentAction.time >= currentAction.getClip().duration) {
                clearInterval(checkEnd);
                animationPaused = true;
                clock.stop();
                setTimeout(() => {
                overlay.style.display = "none";
                result.textContent = "";
                result.style.display = "none";
                }, 2500);
            }
            }, 100);
        } else {
            result.textContent =
              "üí∏ Has hecho una compra impulsiva (-10 salud mental)";
            result.style.color = "#ff3c3c";
            result.style.textShadow = "0 0 10px #ff3c3c";
            result.style.display = "block";

            setTimeout(() => {
              overlay.style.display = "none";
              result.textContent = "";
              result.style.display = "none";
            }, 2500);
        }
    });

    btnNo.addEventListener("click", () => {
      overlay.style.display = "none";
      result.textContent = "üôÇ Decidiste no comprar";
    });

    /* üîä ACTIVAR M√öSICA DESPU√âS DE PRIMER TOQUE */
    window.addEventListener("click", () => {
      iniciarMusica();
    }, { once: true });

  </script>
</body>
</html>



